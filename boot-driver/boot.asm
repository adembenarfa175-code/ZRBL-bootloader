; /boot/zrbl/boot-driver/boot.asm - ZRBL Stage 2/3 Loader
;
; يتم تجميع هذا الملف بصيغة ELF ليتم ربطه مع كود C (command-cfz.c)
;
; مرخص بموجب رخصة جنو العمومية (GPLv3 أو أي إصدار لاحق).
;

; ***************************************************************
; التوجيهات الأساسية
; ***************************************************************

BITS 32                 ; يجب أن نكون في وضع 32-بت (Protected Mode)
section .text           ; قسم الكود القابل للتنفيذ

; ***************************************************************
; تعريفات خارجية وداخلية
; ***************************************************************

extern zrbl_main        ; دالة C الرئيسية (نقطة الدخول الفعلية)
global _start           ; نقطة الدخول الأساسية لملف ELF

; ***************************************************************
; نقطة الدخول والقفز إلى C
; ***************************************************************

_start:
    ; -------------------------------------------------------------
    ; إعداد مقاطع الذاكرة الأساسية (Segments)
    ; -------------------------------------------------------------
    
    mov ax, 0x10        ; قيمة محدد مقطع البيانات (D-Segment Selector)
    mov ds, ax
    mov es, ax
    mov fs, ax
    mov gs, ax
    
    ; -------------------------------------------------------------
    ; إعداد المكدس (Stack) لكود C
    ; -------------------------------------------------------------
    mov esp, 0x90000    ; تعيين رأس المكدس (Stack Pointer)

    ; -------------------------------------------------------------
    ; القفز إلى دالة C
    ; -------------------------------------------------------------
    call zrbl_main      ; استدعاء الدالة الرئيسية في command-cfz.c

    ; -------------------------------------------------------------
    ; النهاية
    ; -------------------------------------------------------------
.halt:
    cli                     ; إيقاف المقاطعات (Disable Interrupts)
    hlt                     ; إيقاف المعالج (Halt)
    jmp .halt               ; حلقة لا نهائية
